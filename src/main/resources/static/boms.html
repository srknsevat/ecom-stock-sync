<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOM Yönetimi - Ecom Stock Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .table th { background-color: #f8f9fa; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .badge { font-size: 0.75em; }
        .search-box { max-width: 300px; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .bom-tree { margin-left: 20px; }
        .bom-level-0 { margin-left: 0; }
        .bom-level-1 { margin-left: 20px; }
        .bom-level-2 { margin-left: 40px; }
        .bom-level-3 { margin-left: 60px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Ecom Stock Sync</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin.html">Yönetim</a>
                <a class="nav-link" href="/materials.html">Malzemeler</a>
                <a class="nav-link" href="/boms.html">BOM Yönetimi</a>
                <a class="nav-link" href="/logout">Çıkış</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-diagram-3"></i> BOM (Ürün Ağacı) Yönetimi</h4>
                    </div>
                    <div class="card-body">
                        <!-- Stats Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="totalBoms">-</h5>
                                        <p class="card-text">Toplam BOM</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="activeBoms">-</h5>
                                        <p class="card-text">Aktif BOM</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="totalComponents">-</h5>
                                        <p class="card-text">Toplam Bileşen</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="avgCost">-</h5>
                                        <p class="card-text">Ortalama Maliyet</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Malzeme kodu veya adı ara...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchBoms()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary" onclick="showAddBomModal()">
                                    <i class="bi bi-plus-circle"></i> Yeni BOM
                                </button>
                                <button class="btn btn-success" onclick="showExplosionModal()">
                                    <i class="bi bi-diagram-3"></i> BOM Patlatma
                                </button>
                            </div>
                        </div>

                        <!-- BOMs Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Ana Malzeme</th>
                                        <th>Bileşen</th>
                                        <th>Miktar</th>
                                        <th>Birim Maliyet</th>
                                        <th>Toplam Maliyet</th>
                                        <th>Operasyon</th>
                                        <th>İş Merkezi</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="bomsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">Yükleniyor...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add BOM Modal -->
    <div class="modal fade" id="addBomModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni BOM Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBomForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ana Malzeme *</label>
                                    <select class="form-select" name="parentId" required>
                                        <option value="">Ana malzeme seçin...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Bileşen Malzeme *</label>
                                    <select class="form-select" name="childId" required>
                                        <option value="">Bileşen malzeme seçin...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Miktar *</label>
                                    <input type="number" class="form-control" name="quantity" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Birim Maliyet</label>
                                    <input type="number" class="form-control" name="unitCost" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Fire Oranı (%)</label>
                                    <input type="number" class="form-control" name="scrapPercentage" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Operasyon</label>
                                    <input type="text" class="form-control" name="operation">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">İş Merkezi</label>
                                    <input type="text" class="form-control" name="workCenter">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Operasyon Süresi (saat)</label>
                                    <input type="number" class="form-control" name="operationTime" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Durum</label>
                                    <select class="form-select" name="status">
                                        <option value="ACTIVE">Aktif</option>
                                        <option value="INACTIVE">Pasif</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="addBom()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BOM Explosion Modal -->
    <div class="modal fade" id="explosionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">BOM Patlatma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Ana Malzeme</label>
                            <select class="form-select" id="explosionParentId">
                                <option value="">Ana malzeme seçin...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Miktar</label>
                            <input type="number" class="form-control" id="explosionQuantity" step="0.01" value="1">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary d-block w-100" onclick="explodeBom()">Patlat</button>
                        </div>
                    </div>
                    <div id="explosionResult"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let boms = [];
        let materials = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBoms();
            loadMaterials();
            loadStats();
        });

        async function loadBoms() {
            try {
                const response = await fetch('/api/boms');
                boms = await response.json();
                displayBoms(boms);
            } catch (error) {
                console.error('Error loading BOMs:', error);
                showAlert('BOM\'lar yüklenirken hata oluştu', 'danger');
            }
        }

        async function loadMaterials() {
            try {
                const response = await fetch('/api/materials');
                materials = await response.json();
                populateMaterialSelects();
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        async function loadStats() {
            try {
                const [bomsResponse, reportsResponse] = await Promise.all([
                    fetch('/api/boms'),
                    fetch('/api/boms/reports')
                ]);

                const bomsData = await bomsResponse.json();
                const reportsData = await reportsResponse.json();

                document.getElementById('totalBoms').textContent = bomsData.length;
                document.getElementById('activeBoms').textContent = bomsData.filter(bom => bom.status === 'ACTIVE').length;
                document.getElementById('totalComponents').textContent = reportsData.reduce((sum, report) => sum + report.componentCount, 0);
                
                const avgCost = reportsData.length > 0 ? 
                    reportsData.reduce((sum, report) => sum + parseFloat(report.totalCost || 0), 0) / reportsData.length : 0;
                document.getElementById('avgCost').textContent = avgCost.toFixed(2) + ' TL';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function populateMaterialSelects() {
            const selects = document.querySelectorAll('select[name="parentId"], select[name="childId"], #explosionParentId');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Malzeme seçin...</option>';
                materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.id;
                    option.textContent = `${material.materialCode} - ${material.materialName}`;
                    select.appendChild(option);
                });
            });
        }

        function displayBoms(bomsList) {
            const tbody = document.getElementById('bomsTableBody');
            tbody.innerHTML = '';

            if (bomsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">BOM bulunamadı</td></tr>';
                return;
            }

            bomsList.forEach(bom => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${bom.parentMaterial?.materialCode || '-'} - ${bom.parentMaterial?.materialName || '-'}</strong></td>
                    <td>${bom.childMaterial?.materialCode || '-'} - ${bom.childMaterial?.materialName || '-'}</td>
                    <td>
                        <span class="badge bg-primary">${bom.quantity} ${bom.parentMaterial?.unit || ''}</span>
                    </td>
                    <td>${bom.unitCost || 0} TL</td>
                    <td>${bom.totalCost || 0} TL</td>
                    <td>${bom.operation || '-'}</td>
                    <td>${bom.workCenter || '-'}</td>
                    <td>
                        <span class="badge ${bom.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                            ${bom.status === 'ACTIVE' ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editBom(${bom.id})" title="Düzenle">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-${bom.status === 'ACTIVE' ? 'warning' : 'success'}" 
                                    onclick="toggleBomStatus(${bom.id}, '${bom.status}')" 
                                    title="${bom.status === 'ACTIVE' ? 'Pasifleştir' : 'Aktifleştir'}">
                                <i class="bi bi-${bom.status === 'ACTIVE' ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteBom(${bom.id})" title="Sil">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchBoms() {
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm.trim() === '') {
                displayBoms(boms);
                return;
            }

            const filteredBoms = boms.filter(bom => 
                (bom.parentMaterial?.materialCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 bom.parentMaterial?.materialName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 bom.childMaterial?.materialCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 bom.childMaterial?.materialName?.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            displayBoms(filteredBoms);
        }

        function showAddBomModal() {
            const modal = new bootstrap.Modal(document.getElementById('addBomModal'));
            modal.show();
        }

        function showExplosionModal() {
            const modal = new bootstrap.Modal(document.getElementById('explosionModal'));
            modal.show();
        }

        async function addBom() {
            const form = document.getElementById('addBomForm');
            const formData = new FormData(form);
            
            const bomData = {
                parentId: formData.get('parentId'),
                childId: formData.get('childId'),
                quantity: parseFloat(formData.get('quantity')),
                unitCost: parseFloat(formData.get('unitCost') || 0),
                operation: formData.get('operation'),
                workCenter: formData.get('workCenter')
            };

            try {
                const response = await fetch('/api/boms/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(bomData)
                });

                if (response.ok) {
                    showAlert('BOM başarıyla eklendi', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addBomModal')).hide();
                    form.reset();
                    loadBoms();
                    loadStats();
                } else {
                    showAlert('BOM eklenirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error adding BOM:', error);
                showAlert('BOM eklenirken hata oluştu', 'danger');
            }
        }

        async function explodeBom() {
            const parentId = document.getElementById('explosionParentId').value;
            const quantity = parseFloat(document.getElementById('explosionQuantity').value);

            if (!parentId || !quantity) {
                showAlert('Lütfen ana malzeme ve miktar seçin', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/boms/${parentId}/explode-detailed?quantity=${quantity}`);
                const explosionResults = await response.json();
                displayExplosionResults(explosionResults);
            } catch (error) {
                console.error('Error exploding BOM:', error);
                showAlert('BOM patlatılırken hata oluştu', 'danger');
            }
        }

        function displayExplosionResults(results) {
            const resultDiv = document.getElementById('explosionResult');
            
            if (results.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-info">BOM patlatma sonucu bulunamadı</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped">';
            html += '<thead><tr><th>Seviye</th><th>Malzeme</th><th>Gerekli Miktar</th><th>Mevcut Stok</th><th>Eksik</th><th>Maliyet</th></tr></thead><tbody>';
            
            results.forEach(result => {
                const levelClass = `bom-level-${result.level}`;
                const shortageClass = result.shortage > 0 ? 'text-danger' : 'text-success';
                
                html += `
                    <tr class="${levelClass}">
                        <td><span class="badge bg-secondary">${result.level}</span></td>
                        <td><strong>${result.material.materialCode}</strong> - ${result.material.materialName}</td>
                        <td>${result.requiredQuantity}</td>
                        <td>${result.availableQuantity}</td>
                        <td class="${shortageClass}">${result.shortage}</td>
                        <td>${result.cost.toFixed(2)} TL</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            resultDiv.innerHTML = html;
        }

        async function toggleBomStatus(bomId, currentStatus) {
            const newStatus = currentStatus === 'ACTIVE' ? 'deactivate' : 'activate';
            
            try {
                const response = await fetch(`/api/boms/${bomId}/${newStatus}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showAlert(`BOM başarıyla ${newStatus === 'activate' ? 'aktifleştirildi' : 'pasifleştirildi'}`, 'success');
                    loadBoms();
                } else {
                    showAlert('BOM durumu değiştirilirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error toggling BOM status:', error);
                showAlert('BOM durumu değiştirilirken hata oluştu', 'danger');
            }
        }

        async function deleteBom(bomId) {
            if (!confirm('Bu BOM\'u silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`/api/boms/${bomId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('BOM başarıyla silindi', 'success');
                    loadBoms();
                    loadStats();
                } else {
                    showAlert('BOM silinirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error deleting BOM:', error);
                showAlert('BOM silinirken hata oluştu', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBoms();
            }
        });
    </script>
</body>
</html>
