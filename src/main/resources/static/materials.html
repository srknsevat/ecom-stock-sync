<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malzeme Yönetimi - Ecom Stock Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .table th { background-color: #f8f9fa; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .badge { font-size: 0.75em; }
        .search-box { max-width: 300px; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Ecom Stock Sync</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin.html">Yönetim</a>
                <a class="nav-link" href="/materials.html">Malzemeler</a>
                <a class="nav-link" href="/logout">Çıkış</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0"><i class="bi bi-box-seam"></i> Malzeme Yönetimi</h4>
                    </div>
                    <div class="card-body">
                        <!-- Stats Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="totalMaterials">-</h5>
                                        <p class="card-text">Toplam Malzeme</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="lowStockCount">-</h5>
                                        <p class="card-text">Düşük Stok</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="totalValue">-</h5>
                                        <p class="card-text">Toplam Değer</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stats-card">
                                    <div class="card-body text-center">
                                        <h5 class="card-title" id="activeCount">-</h5>
                                        <p class="card-text">Aktif Malzeme</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Malzeme kodu veya adı ara...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchMaterials()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary" onclick="showAddMaterialModal()">
                                    <i class="bi bi-plus-circle"></i> Yeni Malzeme
                                </button>
                                <button class="btn btn-success" onclick="showStockAdjustmentModal()">
                                    <i class="bi bi-arrow-up-down"></i> Stok Düzeltme
                                </button>
                            </div>
                        </div>

                        <!-- Materials Table -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Kod</th>
                                        <th>Ad</th>
                                        <th>Kategori</th>
                                        <th>Stok</th>
                                        <th>Min/Max</th>
                                        <th>Maliyet</th>
                                        <th>Tedarikçi</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="materialsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">Yükleniyor...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Material Modal -->
    <div class="modal fade" id="addMaterialModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yeni Malzeme Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMaterialForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Malzeme Kodu *</label>
                                    <input type="text" class="form-control" name="materialCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Malzeme Adı *</label>
                                    <input type="text" class="form-control" name="materialName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Birim</label>
                                    <select class="form-select" name="unit">
                                        <option value="ADET">ADET</option>
                                        <option value="KG">KG</option>
                                        <option value="LİTRE">LİTRE</option>
                                        <option value="METRE">METRE</option>
                                        <option value="PAKET">PAKET</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <input type="text" class="form-control" name="category">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Başlangıç Stoku</label>
                                    <input type="number" class="form-control" name="currentStock" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Minimum Stok</label>
                                    <input type="number" class="form-control" name="minimumStock" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Maksimum Stok</label>
                                    <input type="number" class="form-control" name="maximumStock" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Standart Maliyet</label>
                                    <input type="number" class="form-control" name="standardCost" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Ortalama Maliyet</label>
                                    <input type="number" class="form-control" name="averageCost" step="0.01" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Son Alış Maliyeti</label>
                                    <input type="number" class="form-control" name="lastPurchaseCost" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tedarikçi</label>
                                    <input type="text" class="form-control" name="supplier">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tedarikçi Kodu</label>
                                    <input type="text" class="form-control" name="supplierCode">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="addMaterial()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div class="modal fade" id="stockAdjustmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stok Düzeltme</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockAdjustmentForm">
                        <div class="mb-3">
                            <label class="form-label">Malzeme Seçin</label>
                            <select class="form-select" name="materialId" required>
                                <option value="">Malzeme seçin...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Miktar</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" required>
                            <small class="form-text text-muted">Pozitif: Stok artırma, Negatif: Stok azaltma</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sebep</label>
                            <input type="text" class="form-control" name="reason" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Operatör</label>
                            <input type="text" class="form-control" name="operator" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="adjustStock()">Düzelt</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let materials = [];

        // Load materials on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadMaterials();
            loadStats();
        });

        async function loadMaterials() {
            try {
                const response = await fetch('/api/materials');
                materials = await response.json();
                displayMaterials(materials);
            } catch (error) {
                console.error('Error loading materials:', error);
                showAlert('Malzemeler yüklenirken hata oluştu', 'danger');
            }
        }

        async function loadStats() {
            try {
                const [totalResponse, lowStockResponse, totalValueResponse, activeResponse] = await Promise.all([
                    fetch('/api/materials/stats/active-count'),
                    fetch('/api/materials/stats/low-stock-count'),
                    fetch('/api/materials/stats/total-value'),
                    fetch('/api/materials/stats/active-count')
                ]);

                document.getElementById('totalMaterials').textContent = await totalResponse.text();
                document.getElementById('lowStockCount').textContent = await lowStockResponse.text();
                document.getElementById('totalValue').textContent = (await totalValueResponse.text()) + ' TL';
                document.getElementById('activeCount').textContent = await activeResponse.text();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayMaterials(materialsList) {
            const tbody = document.getElementById('materialsTableBody');
            tbody.innerHTML = '';

            if (materialsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Malzeme bulunamadı</td></tr>';
                return;
            }

            materialsList.forEach(material => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${material.materialCode}</strong></td>
                    <td>${material.materialName}</td>
                    <td>${material.category || '-'}</td>
                    <td>
                        <span class="badge ${material.currentStock > 0 ? 'bg-success' : 'bg-danger'}">
                            ${material.currentStock} ${material.unit || ''}
                        </span>
                    </td>
                    <td>
                        <small>Min: ${material.minimumStock || 0}</small><br>
                        <small>Max: ${material.maximumStock || '-'}</small>
                    </td>
                    <td>
                        <small>Ort: ${material.averageCost || 0} TL</small><br>
                        <small>Son: ${material.lastPurchaseCost || 0} TL</small>
                    </td>
                    <td>${material.supplier || '-'}</td>
                    <td>
                        <span class="badge ${material.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                            ${material.status === 'ACTIVE' ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editMaterial(${material.id})" title="Düzenle">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="adjustStockForMaterial(${material.id})" title="Stok Düzelt">
                                <i class="bi bi-arrow-up-down"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteMaterial(${material.id})" title="Sil">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchMaterials() {
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm.trim() === '') {
                displayMaterials(materials);
                return;
            }

            const filteredMaterials = materials.filter(material => 
                material.materialCode.toLowerCase().includes(searchTerm.toLowerCase()) ||
                material.materialName.toLowerCase().includes(searchTerm.toLowerCase())
            );
            displayMaterials(filteredMaterials);
        }

        function showAddMaterialModal() {
            const modal = new bootstrap.Modal(document.getElementById('addMaterialModal'));
            modal.show();
        }

        function showStockAdjustmentModal() {
            const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
            loadMaterialsForAdjustment();
            modal.show();
        }

        async function loadMaterialsForAdjustment() {
            const select = document.querySelector('#stockAdjustmentModal select[name="materialId"]');
            select.innerHTML = '<option value="">Malzeme seçin...</option>';
            
            materials.forEach(material => {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.materialCode} - ${material.materialName}`;
                select.appendChild(option);
            });
        }

        async function addMaterial() {
            const form = document.getElementById('addMaterialForm');
            const formData = new FormData(form);
            const materialData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/materials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(materialData)
                });

                if (response.ok) {
                    showAlert('Malzeme başarıyla eklendi', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addMaterialModal')).hide();
                    form.reset();
                    loadMaterials();
                    loadStats();
                } else {
                    showAlert('Malzeme eklenirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error adding material:', error);
                showAlert('Malzeme eklenirken hata oluştu', 'danger');
            }
        }

        async function adjustStock() {
            const form = document.getElementById('stockAdjustmentForm');
            const formData = new FormData(form);
            const materialId = formData.get('materialId');
            const quantity = parseFloat(formData.get('quantity'));
            const reason = formData.get('reason');
            const operator = formData.get('operator');

            try {
                const response = await fetch(`/api/materials/${materialId}/stock/adjust`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `quantity=${quantity}&reason=${encodeURIComponent(reason)}&operator=${encodeURIComponent(operator)}`
                });

                if (response.ok) {
                    showAlert('Stok başarıyla düzeltildi', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal')).hide();
                    form.reset();
                    loadMaterials();
                    loadStats();
                } else {
                    showAlert('Stok düzeltilirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error adjusting stock:', error);
                showAlert('Stok düzeltilirken hata oluştu', 'danger');
            }
        }

        function adjustStockForMaterial(materialId) {
            const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
            document.querySelector('#stockAdjustmentModal select[name="materialId"]').value = materialId;
            modal.show();
        }

        async function deleteMaterial(materialId) {
            if (!confirm('Bu malzemeyi silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch(`/api/materials/${materialId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Malzeme başarıyla silindi', 'success');
                    loadMaterials();
                    loadStats();
                } else {
                    showAlert('Malzeme silinirken hata oluştu', 'danger');
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                showAlert('Malzeme silinirken hata oluştu', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMaterials();
            }
        });
    </script>
</body>
</html>
